{"version":3,"names":["CameraController","InputHandler","Control","parseObj","Clock","Utils","light","pos","Vector3","color","globalUniform","clock","cameraController","camera","Scene.Camera","canvasEl","document","querySelector","fpsEl","loader","Loader","width","height","graph","Scene.Graph","inputHandler","skyboxTex","load","makeBlack","position","normal","texcoord","african_head","positions","texcoords","normals","i","length","push","Vector4","blackLightMaterial","ambientStrength","diffuseStrength","specularStrength","shininess","blackTransform","blackProgram","ShaderProgram","BlackShader","Scene.Transform","Scene.Mesh","wordMatrix","Matrix4","makeScale","blackMaterial","Scene.Material","Scene.Uniforms","prepareScene","autoMaterial","gUniform","append","set","cacheStr","tick","_time","innerHTML","fps","tempCacheStr","x","y","z","onRendy","setOnTick","start","window"],"sources":["./src/index.ts"],"sourcesContent":["import { Matrix4, Vector3, Vector4 } from 'three';\nimport { african_head } from './assets/african-head';\nimport { Scene, ShaderProgram, Utils, Control, } from './engine';\nimport * as BlackShader from './shader/black';\n// import * as WallShader from './shader/wall';\n// import * as SkyBoxShader from \"./shader/skybox\";\n// import * as RayTraceShader from \"./shader/raytrace\"\n\nimport { Texture2D } from './engine/geometry/texture';\nimport Loader from './engine/utils/loader';\n// import { screen_quad, Cute } from './engine/mesh';\n\n\nconst { CameraController, InputHandler } = Control\nconst { parseObj, Clock } = Utils\n// const {  Texture2D } = Geometry\n\nconst light: PhongLightPoint = {\n  pos: new Vector3(0.0, 0.0, 14.0),\n  color: new Vector3(0.7, 0.7, 0.7),\n};\n\nlet globalUniform: uniformsProp = {\n  light,\n};\n\nlet clock = new Clock();\nlet cameraController;\nlet camera: Scene.Camera = new Scene.Camera();\nconst canvasEl = document.querySelector('canvas');\nconst fpsEl = document.querySelector('#fps');\nconst loader = new Loader('./assets/');\ncanvasEl.width = 500;\ncanvasEl.height = 500;\nlet graph = new Scene.Graph({ canvasEl });\nlet inputHandler = new InputHandler(canvasEl);\n\nconst skyboxTex = ['./skybox/top.jpg', './skybox/bottom.jpg', './skybox/front.jpg', './skybox/back.jpg', './skybox/left.jpg', './skybox/right.jpg']\n\nloader.load(['texture.png', 'wall_normal_map.png', ...skyboxTex]);\n\n// 黑人头\nconst makeBlack = () => {\n  const { position, normal, texcoord } = parseObj(african_head);\n  const positions: Vector4[] = [];\n  const texcoords: Vector4[] = [];\n  const normals: Vector4[] = [];\n  for (let i = 0; i < position.length; i += 3) {\n    positions.push(new Vector4(position[i], position[i + 1], position[i + 2], 1));\n    texcoords.push(new Vector4(texcoord[i], texcoord[i + 1], 0, 1.0));\n    normals.push(new Vector4(normal[i], normal[i + 1], normal[i + 2], 1));\n  }\n  const blackLightMaterial: PhongLightMaterial = {\n    // 反射的环境光强度\n    ambientStrength: 0.8,\n    // 反射的漫反射光强度 Lambert\n    diffuseStrength: 0.9,\n    // 反射的镜面反射光强度\n    specularStrength: 1,\n    // 值越大，表面越平滑\n    shininess: 50,\n  }\n  let blackTransform: Scene.Transform;\n  const blackProgram = new ShaderProgram(BlackShader);\n  blackTransform = new Scene.Transform([new Scene.Mesh({ position: positions, texcoord: texcoords, normal: normals })]);\n  blackTransform.wordMatrix = new Matrix4().makeScale(10, -10, 10)\n  const blackMaterial = new Scene.Material(blackProgram, new Scene.Uniforms({ blackLightMaterial, texture: new Texture2D(loader.resources['texture.png']) }), [blackTransform]);\n  return blackMaterial;\n}\n\n// 墙\n// const makeWall = () => {\n//   const wallLightMaterial: PhongLightMaterial = {\n//     // 反射的环境光强度\n//     ambientStrength: 0.2,\n//     // 反射的漫反射光强度 Lambert\n//     diffuseStrength: 0.5,\n//     // 反射的镜面反射光强度\n//     specularStrength: 5,\n//     // 值越大，表面越平滑\n//     shininess: 50,\n//   };\n//   const wallProgram = new ShaderProgram(WallShader);\n//   let wallTransform: Scene.Transform;\n//   wallTransform = new Scene.Transform([new Scene.Mesh(screen_quad())])\n//   // wallTransform.wordMatrix = new Matrix4().makeScale(4, 4, 4)\n//   const wallMaterial = new Scene.Material(wallProgram, new Scene.Uniforms({ wallLightMaterial, normal: new Texture2D(loader.resources['wall_normal_map.png']) }), [wallTransform]);\n//   return wallMaterial;\n// }\n\n// 天空盒 TODO\n// const makeSkyBox = () => {\n//   const skyBoxProgram = new ShaderProgram(SkyBoxShader);\n//   const skyboxTexture = {\n//     posX: new Texture2D(loader.resources['./skybox/right.jpg']),\n//     negX: new Texture2D(loader.resources['./skybox/left.jpg']),\n//     posY: new Texture2D(loader.resources['./skybox/top.jpg']),\n//     negY: new Texture2D(loader.resources['./skybox/bottom.jpg']),\n//     posZ: new Texture2D(loader.resources['./skybox/front.jpg']),\n//     negZ: new Texture2D(loader.resources['./skybox/back.jpg']),\n//   }\n//   const skyBoxTransform = new Scene.Transform([new Scene.SkyBox([new Scene.Mesh(Cute())], new Scene.Uniforms(skyboxTexture))]);\n//   skyBoxTransform.wordMatrix = new Matrix4().makeScale(1000, 1000, 1000)\n//   const skyBoxMaterial = new Scene.Material(skyBoxProgram, new Scene.Uniforms({}), [skyBoxTransform])\n//   return skyBoxMaterial;\n// }\n\n// 光线追踪\n// const makeRayTrace = () => {\n//   const { position, normal, texcoord } = parseObj(african_head);\n//   const positions: Vector4[] = [];\n//   const texcoords: Vector4[] = [];\n//   const normals: Vector4[] = [];\n//   for (let i = 0; i < position.length; i += 3) {\n//     positions.push(new Vector4(position[i], position[i + 1], position[i + 2], 1));\n//     texcoords.push(new Vector4(texcoord[i], texcoord[i + 1], 0, 1.0));\n//     normals.push(new Vector4(normal[i], normal[i + 1], normal[i + 2], 1));\n//   }\n//\n//   const rayTraceUniform = { position: positions, texcoord: texcoords, normal: normals }\n//\n//   const screenMesh = new Scene.Mesh(screen_quad())\n//   const rayTrace = new Scene.Material(new ShaderProgram(RayTraceShader), new Scene.Uniforms({}), [screenMesh])\n//   return rayTrace;\n// }\n\n// 纹理阴影\n// const makeShadowMap = () => {\n//   const groundTransform: Scene.Transform = new Scene.Transform([new Scene.Mesh(screen_quad())]);\n//   const zBufferFbo = new Scene.RenderTarget([groundTransform])\n// }\n\nconst prepareScene = () => {\n  cameraController = new CameraController(inputHandler, camera);\n  const autoMaterial = makeBlack()\n  const gUniform = new Scene.Uniforms(globalUniform, [autoMaterial]);\n  camera.append(gUniform);\n  graph.append(camera);\n  camera.position.set(0, 0, 15);\n};\n\nlet cacheStr = ''\nconst tick = (_time: number) => {\n  fpsEl.innerHTML = clock.fps + '';\n  cameraController.tick();\n  const tempCacheStr = `${camera.position.x}-${camera.position.y}-${camera.position.z}-${camera.x}-${camera.y}`\n  if (cacheStr === tempCacheStr) return\n  cacheStr = tempCacheStr\n  graph.tick();\n};\n\nloader.onRendy = () => {\n  prepareScene();\n  clock.setOnTick(tick);\n  clock.start();\n  // clock.stop();\n  window['camera'] = camera\n  window['clock'] = clock;\n};\n"],"mappings":"6IAaA,MAAMA,iBAAEA,EAAgBC,aAAEA,GAAiBC,EAC3C,MAAMC,SAAEA,EAAQC,MAAEA,GAAUC,EAG5B,MAAMC,EAAyB,CAC7BC,IAAK,IAAIC,EAAA,QACTC,MAAO,IAAID,EAAQ,GAAK,GAAK,KAG/B,IAAAE,EAAA,CACEJ,SAGF,IAAAK,EAAA,IAAAP,EACA,IAAIQ,EACJ,IAAIC,EAAuB,IAAIC,EAC/B,MAAMC,EAAWC,SAASC,cAAA,UAC1B,MAAMC,EAAQF,SAASC,cAAc,QACrC,MAAME,EAAS,IAAIC,EAAO,aAC1BL,EAASM,MAAQ,IACjBN,EAASO,OAAS,IAClB,IAAIC,EAAQ,IAAIC,gBAChB,IAAIC,EAAe,IAAIxB,EAAac,GAEpC,MAAMW,EAAY,CAAC,mBAAoB,yGAEvCP,EAAOQ,KAAK,CAAC,cAAe,yBAA0BD,IAGtD,MAAME,EAAA,KACJ,MAAMC,SAAEA,EAAQC,OAAEA,EAAAC,YAAA5B,EAAA6B,GAClB,MAAMC,EAAuB,GAC7B,MAAMC,EAAuB,GAC7B,MAAMC,EAAqB,GAC3B,IAAK,IAAIC,EAAI,EAAGA,EAACP,EAAAQ,OAAAD,GAAA,GACfH,EAAUK,KAAK,IAAIC,EAAQV,EAASO,GAAIP,EAAAO,EAAA,GAAAP,EAAAO,EAAA,OACxCF,EAAUI,KAAK,IAAIC,EAAQR,EAASK,GAAIL,EAASK,EAAI,GAAI,EAAG,IAC5DD,EAAQG,KAAK,IAAIC,EAAQT,EAAOM,GAAIN,EAAOM,EAAI,GAAIN,EAAOM,EAAI,GAAI,G,CAEpE,MAAAI,EAAA,CAEEC,gBAAA,GAEAC,gBAAiB,GAEjBC,iBAAA,EAEAC,UAAW,IAEb,IAAAC,EACA,MAAMC,EAAY,IAAAC,EAAAC,GAClBH,EAAiB,IAAII,EAAgB,CAAC,IAAIC,EAAU,CAAArB,SAAAI,EAAAF,SAAAG,EAAAJ,OAAAK,MACpDU,EAAeM,YAAa,IAAIC,GAAUC,UAAU,IAAK,GAAI,IAC7D,MAAMC,EAAgB,IAAIC,EAAeT,EAAc,IAAIU,yEAC3D,OAAOF,CAAa,EAiEtB,MAAAG,EAAA,KACE7C,EAAmB,IAAIZ,EAAAyB,EAAAZ,GACvB,MAAM6C,EAAe9B,IACrB,MAAM+B,EAAW,IAAIH,SACrB3C,EAAO+C,OAAOD,GACdpC,EAAMqC,OAAO/C,GACbA,EAAOgB,SAASgC,IAAI,EAAC,OAGvB,IAAAC,EAAA,GACA,MAAMC,EAAQC,IACZ9C,EAAM+C,UAAYtD,EAAKuD,IAAA,GACvBtD,EAAiBmD,OACjB,MAAMI,EAAe,GAAGtD,EAAAgB,SAAAuC,KAAAvD,EAAAgB,SAAAwC,KAAAxD,EAAAgB,SAAAyC,KAAAzD,EAAAuD,KAAAvD,EAAAwD,IACxB,GAAIP,IAAaK,EAAc,OAC/BL,EAAQK,EACR5C,EAAMwC,MAAM,EAGd5C,EAAAoD,QAAA,KACEd,IACA9C,EAAM6D,UAAST,GACfpD,EAAM8D,QAENC,OAAO,UAAS7D,EAChB6D,OAAO,SAAW/D,CAAK,E"}